# frozen_string_literal: true

class CreateFlowTrackerTables < ActiveRecord::Migration[<%= ActiveRecord::Migration.current_version %>]
  def change
    # Enable UUID extension if not already enabled
    enable_extension "pgcrypto" unless extension_enabled?("pgcrypto")

    # =====================================================
    # flow_tracker_processes - Definition/Template of a job
    # =====================================================
    # One record per unique job/service (e.g., "ProactiveEngagement::MessageProcessorJob#perform")
    # Found with find_or_create_by(business_logic:)
    create_table :flow_tracker_processes, id: :uuid do |t|
      t.string :name, null: false                    # Display name (e.g., "Message Processor")
      t.string :business_logic, null: false          # Unique identifier (e.g., "MyWorker#perform")
      t.integer :category, default: 0, null: false   # Enum: jobs, services, api, other
      t.text :description                            # Optional description
      t.boolean :active, default: true, null: false  # Can disable tracking
      t.jsonb :settings, default: {}                 # Configuration for this process

      t.timestamps
    end

    add_index :flow_tracker_processes, :business_logic, unique: true
    add_index :flow_tracker_processes, :name
    add_index :flow_tracker_processes, :category
    add_index :flow_tracker_processes, :active

    # =====================================================
    # flow_tracker_flows - Each execution of a process
    # =====================================================
    # One record per job execution
    create_table :flow_tracker_flows, id: :uuid do |t|
      t.references :process, type: :uuid, null: false,
                   foreign_key: { to_table: :flow_tracker_processes, on_delete: :cascade }
      t.integer :status, default: 0, null: false     # Enum: running, completed, failed, skipped
      t.datetime :started_at
      t.datetime :finished_at
      t.integer :duration_ms
      t.integer :ok_count, default: 0                # Count of successful sub-operations
      t.integer :ko_count, default: 0                # Count of failed sub-operations
      t.integer :skip_count, default: 0              # Count of skipped sub-operations
      t.integer :total, default: 0                   # Total items processed
      t.float :progress                              # Progress percentage (0.0 - 1.0)
      t.jsonb :metadata, default: {}                 # Execution-specific data
      t.string :triggered_by                         # What triggered this execution
      t.string :correlation_id                       # For tracing across services
      t.text :error_message                          # Error message if failed
      t.text :error_backtrace                        # Stack trace if failed

      t.timestamps
    end

    add_index :flow_tracker_flows, :status
    add_index :flow_tracker_flows, :started_at
    add_index :flow_tracker_flows, :correlation_id
    add_index :flow_tracker_flows, [:process_id, :started_at]
    add_index :flow_tracker_flows, :metadata, using: :gin

    # =====================================================
    # flow_tracker_log_entries - Logs per execution
    # =====================================================
    # Attached to flow (execution), not process (definition)
    create_table :flow_tracker_log_entries, id: :uuid do |t|
      t.references :flow, type: :uuid, null: false,
                   foreign_key: { to_table: :flow_tracker_flows, on_delete: :cascade }
      t.integer :level, default: 0, null: false      # Enum: debug, info, warn, error
      t.text :content, null: false                   # Log message
      t.jsonb :context, default: {}                  # Structured data
      t.datetime :logged_at, null: false

      t.timestamps
    end

    add_index :flow_tracker_log_entries, :level
    add_index :flow_tracker_log_entries, :logged_at
    add_index :flow_tracker_log_entries, [:flow_id, :logged_at]
  end
end
