<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h2>
    <%= @process.name %>
    <% unless @process.active %>
      <span class="status-badge status-skipped">inactive</span>
    <% end %>
  </h2>
  <div>
    <a href="<%= processes_path %>" class="btn btn-secondary">Back to List</a>
    <form action="<%= process_path(@process) %>" method="post" style="display: inline;">
      <input type="hidden" name="_method" value="delete">
      <button type="submit" class="btn btn-danger" onclick="return confirm('Delete this process and all its flows?')">
        Delete
      </button>
    </form>
  </div>
</div>

<div class="process-meta">
  <div class="meta-item">
    <div class="label">Business Logic</div>
    <div class="value" style="font-family: monospace;"><%= @process.business_logic %></div>
  </div>
  <div class="meta-item">
    <div class="label">Category</div>
    <div class="value"><%= category_name(@process.category) %></div>
  </div>
  <div class="meta-item">
    <div class="label">Total Executions</div>
    <div class="value"><%= @stats[:total_flows] %></div>
  </div>
  <div class="meta-item">
    <div class="label">Success Rate</div>
    <div class="value">
      <% if @process.success_rate %>
        <span class="<%= @process.success_rate >= 90 ? 'status-completed' : (@process.success_rate >= 70 ? '' : 'status-failed') %>">
          <%= @process.success_rate %>%
        </span>
      <% else %>
        -
      <% end %>
    </div>
  </div>
  <div class="meta-item">
    <div class="label">Avg Duration</div>
    <div class="value"><%= format_duration(@stats[:avg_duration_ms]) %></div>
  </div>
  <div class="meta-item">
    <div class="label">Last Execution</div>
    <div class="value"><%= time_ago(@stats[:last_execution]) %></div>
  </div>
  <% if @process.description.present? %>
    <div class="meta-item" style="grid-column: 1 / -1;">
      <div class="label">Description</div>
      <div class="value"><%= @process.description %></div>
    </div>
  <% end %>
  <% if present?(@process.settings) && @process.settings.any? %>
    <div class="meta-item" style="grid-column: 1 / -1;">
      <div class="label">Settings</div>
      <div class="value"><pre style="margin: 0; font-size: 12px;"><%= JSON.pretty_generate(@process.settings) %></pre></div>
    </div>
  <% end %>
</div>

<div class="stats-grid" style="margin-bottom: 20px;">
  <div class="stat-card running">
    <div class="value"><%= @stats[:running] %></div>
    <div class="label">Running</div>
  </div>
  <div class="stat-card completed">
    <div class="value"><%= @stats[:completed] %></div>
    <div class="label">Completed</div>
  </div>
  <div class="stat-card failed">
    <div class="value"><%= @stats[:failed] %></div>
    <div class="label">Failed</div>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <span class="card-title">Executions (<%= @flows.count %>)</span>
  </div>

  <form class="filter-form" method="get" action="<%= process_path(@process) %>" style="margin-bottom: 0; padding: 15px;">
    <select name="status">
      <option value="">All Statuses</option>
      <option value="0" <%= 'selected' if params[:status] == '0' %>>Running</option>
      <option value="1" <%= 'selected' if params[:status] == '1' %>>Completed</option>
      <option value="2" <%= 'selected' if params[:status] == '2' %>>Failed</option>
      <option value="3" <%= 'selected' if params[:status] == '3' %>>Skipped</option>
    </select>

    <input type="date" name="date" value="<%= params[:date] %>">

    <button type="submit" class="btn btn-primary">Filter</button>
    <a href="<%= process_path(@process) %>" class="btn btn-secondary">Clear</a>
  </form>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Started</th>
          <th>Status</th>
          <th>Duration</th>
          <th>Progress</th>
          <th>Triggered By</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @flows.each do |flow| %>
          <tr>
            <td>
              <a href="<%= flow_path(flow) %>"><%= format_time(flow.started_at) %></a>
              <div style="font-size: 11px; color: var(--text-muted);"><%= time_ago(flow.started_at) %></div>
              <% if present?(flow.metadata) && flow.metadata.any? %>
                <div style="font-size: 11px; color: var(--text-muted);">
                  <%= format_metadata(flow.metadata) %>
                </div>
              <% end %>
            </td>
            <td><span class="status-badge <%= status_class(flow.status) %>"><%= status_name(flow.status) %></span></td>
            <td><%= format_duration(flow.duration_ms) %></td>
            <td>
              <% if flow.total && flow.total > 0 %>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: <%= [(flow.ok_count.to_f / flow.total * 100), 100].min %>%; height: 100%; background: var(--success);"></div>
                  </div>
                  <span style="font-size: 11px; white-space: nowrap;"><%= flow.ok_count %>/<%= flow.total %></span>
                </div>
                <% if flow.ko_count > 0 %>
                  <div style="font-size: 11px; color: var(--error);"><%= flow.ko_count %> failed</div>
                <% end %>
              <% else %>
                -
              <% end %>
            </td>
            <td><%= flow.triggered_by || '-' %></td>
            <td>
              <a href="<%= flow_path(flow) %>" class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;">
                View Logs
              </a>
              <form action="<%= root_path %>/flows/<%= flow.id %>" method="post" style="display: inline;">
                <input type="hidden" name="_method" value="delete">
                <button type="submit" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="return confirm('Delete this execution?')">
                  Delete
                </button>
              </form>
            </td>
          </tr>
        <% end %>

        <% if @flows.empty? %>
          <tr>
            <td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 40px;">
              No executions recorded
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
